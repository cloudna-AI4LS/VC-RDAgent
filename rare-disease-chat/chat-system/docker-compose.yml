version: '3.8'

networks:
  rarellm-network:
    driver: bridge

services:
  mcp-server:
    networks:
      - rarellm-network
    build:
      context: ../mcp-server
      dockerfile: Dockerfile
    container_name: rarellm-mcp-server
    ports:
      - "3000:3000"
    environment:
      - PROJECT_ROOT=/app
      - MCP_SIMPLE_TOOL_DIR=/app/mcp-server/mcp_simple_tool
      - PORT=3000
      - MCP_ENDPOINT=http://localhost:3000/mcp/
      - HF_ENDPOINT=https://hf-mirror.com
    volumes:
      # Mount data directory (for persistence)
      - ../mcp-server/mcp_simple_tool/data:/app/mcp-server/mcp_simple_tool/data
      # Mount log directory
      - ../mcp-server:/app/mcp-server
    command: mcp-simple-tool --port 3000 --json-response
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Chat system service (start mcp-server first)
  chat-system:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rarellm-chat-system
    depends_on:
      - mcp-server
    networks:
      - rarellm-network
    environment:
      - PROJECT_ROOT=/app
      - MCP_SIMPLE_TOOL_DIR=/app/mcp-server/mcp_simple_tool
      - MCP_ENDPOINT=http://mcp-server:3000/mcp/
      - MCP_TIMEOUT=600
      - HF_ENDPOINT=https://hf-mirror.com
    volumes:
      # Mount project directory for script access
      - .:/app
    command: python phenotype_to_disease_controller_langchain_stream_api.py
    stdin_open: true
    tty: true
    restart: unless-stopped
