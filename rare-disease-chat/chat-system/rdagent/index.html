<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VCAP-RDAgent: Rare Disease Intelligent Diagnosis System</title>
    <!-- Markdownæ¸²æŸ“åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <!-- ä»£ç é«˜äº®åº“ï¼ˆå¯é€‰ï¼‰ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            height: 90vh;
            overflow: hidden;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .sidebar .example-case {
            margin-bottom: 10px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            transition: all 0.2s ease;
        }

        .sidebar .example-case:hover {
            background: #e3f2fd;
            border-color: #667eea;
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .sidebar .example-case strong {
            display: block;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .sidebar .example-case {
            font-size: 12px;
            line-height: 1.5;
            color: #555;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 20px 20px 0 0;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-items: flex-end;
        }

        .message.assistant {
            align-items: flex-start;
        }

        .message-content {
            max-width: 100%;
            padding: 15px 20px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.6;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }

        .message.assistant .message-content h2,
        .message.assistant .message-content h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #667eea;
        }

        .message.assistant .message-content h2:first-child,
        .message.assistant .message-content h3:first-child {
            margin-top: 0;
        }

        .message.assistant .message-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .message.assistant .message-content table th,
        .message.assistant .message-content table td {
            padding: 10px;
            border: 1px solid #e0e0e0;
            text-align: left;
        }

        .message.assistant .message-content table th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .message.assistant .message-content ul,
        .message.assistant .message-content ol {
            margin: 10px 0;
            padding-left: 25px;
        }

        .message.assistant .message-content li {
            margin: 5px 0;
        }

        /* Markdownæ ·å¼å¢å¼º */
        .message.assistant .message-content {
            line-height: 1.8;
        }

        .message.assistant .message-content h1,
        .message.assistant .message-content h2,
        .message.assistant .message-content h3,
        .message.assistant .message-content h4,
        .message.assistant .message-content h5,
        .message.assistant .message-content h6 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
            color: #667eea;
        }

        .message.assistant .message-content h1 {
            font-size: 2em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
        }

        .message.assistant .message-content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
        }

        .message.assistant .message-content h3 {
            font-size: 1.25em;
        }

        .message.assistant .message-content p {
            margin: 10px 0;
        }

        .message.assistant .message-content code {
            background-color: rgba(27, 31, 35, 0.05);
            border-radius: 3px;
            font-size: 85%;
            margin: 0;
            padding: 0.2em 0.4em;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }

        .message.assistant .message-content pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            font-size: 85%;
            line-height: 1.45;
            overflow: auto;
            padding: 16px;
            margin: 16px 0;
        }

        .message.assistant .message-content pre code {
            background-color: transparent;
            border: 0;
            display: inline;
            line-height: inherit;
            margin: 0;
            overflow: visible;
            padding: 0;
            word-wrap: normal;
        }

        .message.assistant .message-content blockquote {
            border-left: 4px solid #dfe2e5;
            color: #6a737d;
            padding: 0 1em;
            margin: 16px 0;
        }

        .message.assistant .message-content a {
            color: #667eea;
            text-decoration: none;
        }

        .message.assistant .message-content a:hover {
            text-decoration: underline;
        }

        .message.assistant .message-content img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin: 16px 0;
        }

        .message.assistant .message-content hr {
            background-color: #e1e4e8;
            border: 0;
            height: 0.25em;
            margin: 24px 0;
            padding: 0;
        }

        .status-indicator {
            display: block;
            padding: 5px 12px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 12px;
            font-size: 12px;
            margin-bottom: 5px;
            animation: pulse 2s infinite;
        }

        /* å·²å®ŒæˆçŠ¶æ€ï¼šç»¿è‰²åŒºåˆ† */
        .status-indicator.completed {
            background: #e8f5e9;
            color: #2e7d32;
        }

        #statusIndicator {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        /* ç¤ºä¾‹æ¡ˆä¾‹æ ·å¼ */
        .message-content ul li {
            transition: all 0.2s ease;
        }

        .message-content ul li:hover {
            background: #e3f2fd !important;
            transform: translateX(4px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .input-container {
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e0e0e0;
            border-radius: 0 0 20px 20px;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-box {
            flex: 1;
            position: relative;
        }

        textarea {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 50px;
            max-height: 150px;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-send:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-clear {
            background: #f5f5f5;
            color: #666;
        }

        .btn-clear:hover:not(:disabled) {
            background: #e0e0e0;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 15px;
            background: #f5f5f5;
            border-radius: 12px;
            color: #666;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* æ¨ç†å†…å®¹å¯æŠ˜å å¯¹è¯æ¡† */
        .reasoning-container {
            width: 100%;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .reasoning-toggle {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
            user-select: none;
        }

        .reasoning-toggle:hover {
            background: #eeeeee;
            border-color: #667eea;
        }

        .reasoning-toggle .toggle-icon {
            font-size: 14px;
            color: #667eea;
            transition: transform 0.2s ease;
        }

        .reasoning-toggle.expanded .toggle-icon {
            transform: rotate(90deg);
        }

        .reasoning-content {
            display: none;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 15px;
            margin-top: -1px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.6;
            color: #555;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .reasoning-content.expanded {
            display: block;
        }

        .reasoning-content code {
            background-color: rgba(27, 31, 35, 0.05);
            border-radius: 3px;
            font-size: 85%;
            padding: 0.2em 0.4em;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #c62828;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                height: 100vh;
                border-radius: 0;
            }

            .header {
                border-radius: 0;
            }

            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                overflow-y: auto;
            }

            .sidebar h3 {
                font-size: 14px;
                margin-bottom: 10px;
            }

            .sidebar .example-case {
                padding: 8px;
                font-size: 11px;
            }

            .sidebar .example-case strong {
                font-size: 12px;
            }

            .content-area {
                flex: 1;
            }

            .message-content {
                max-width: 85%;
            }

            .input-wrapper {
                flex-direction: column;
            }

            .button-group {
                width: 100%;
            }

            button {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§  VCAP-RDAgent: ç½•è§ç—…æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿ</h1>
            <p>åŸºäºè™šæ‹Ÿæ¡ˆä¾‹å¢å¼ºæç¤ºæ¡†æ¶çš„ç½•è§ç—…æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿï¼Œé‡‡ç”¨å¤šæ™ºèƒ½ä½“æ¶æ„ï¼Œæ”¯æŒè¡¨å‹æå–ã€ç–¾ç—…è¯Šæ–­å’Œè¯„ä¼°</p>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§è¾¹æ  -->
            <div class="sidebar">
                <h3>ğŸ“‹ ç¤ºä¾‹æ¡ˆä¾‹</h3>
                <div class="example-case" 
                    data-example="The patient presents with the following phenotypic abnormalities: HP:0000793, HP:0001974, HP:0002205, HP:0002633, HP:0003496, and HP:0100778. Please analyze these phenotypes and identify the most likely rare diseases that could explain this combination of features.">
                    <strong>æ¡ˆä¾‹1ï¼š</strong> 
                    <span>æ‚£è€…è¡¨ç°ä¸ºä»¥ä¸‹è¡¨å‹å¼‚å¸¸ï¼šHP:0000793, HP:0001974, HP:0002205, HP:0002633, HP:0003496, å’Œ HP:0100778ã€‚è¯·åˆ†æè¿™äº›è¡¨å‹å¹¶è¯†åˆ«æœ€å¯èƒ½çš„ç½•è§ç–¾ç—…ã€‚</span>
                </div>
                <div class="example-case" 
                    data-example="The patient presents with the following phenotypic abnormalities: membranoproliferative glomerulonephritis, increased total leukocyte count, recurrent respiratory infections, vasculitis, increased circulating IgM level, and cryoglobulinemia. Please analyze these phenotypes and identify the most likely rare diseases that could explain this combination of features.">
                    <strong>æ¡ˆä¾‹2ï¼š</strong> 
                    <span>æ‚£è€…è¡¨å‹ç»„åˆï¼šè†œå¢ç”Ÿæ€§è‚¾å°çƒè‚¾ç‚ã€ç™½ç»†èƒæ€»æ•°å¢é«˜ã€åå¤å‘¼å¸é“æ„ŸæŸ“ã€è¡€ç®¡ç‚ã€å¾ªç¯IgMæ°´å¹³å‡é«˜ã€å†·çƒè›‹ç™½è¡€ç—‡ã€‚è¯·åˆ†æè¿™äº›è¡¨å‹å¹¶è¯†åˆ«æœ€å¯èƒ½çš„ç½•è§ç–¾ç—…ã€‚</span>
                </div>
                <div class="example-case" 
                    data-example='"HP:0000421", "HP:0002105", "HP:0002113", "HP:0002829", "HP:0002907", "HP:0011227", "HP:0012213", "HP:0032230"'>
                    <strong>æ¡ˆä¾‹3ï¼š</strong> 
                    <span>HP:0000421, HP:0002105, HP:0002113, HP:0002829, HP:0002907, HP:0011227, HP:0012213, HP:0032230</span>
                </div>
                <div class="example-case" 
                    data-example="What are the main features of White-Kernohan syndrome?">
                    <strong>æ¡ˆä¾‹4ï¼š</strong> 
                    <span>White-Kernohanç»¼åˆå¾çš„ä¸»è¦ç‰¹å¾æ˜¯ä»€ä¹ˆï¼Ÿ</span>
                </div>
                <div class="example-case" 
                    data-example="What diseases are represented by ORPHA:397, OMIM:253800, and OMIM:153400?">
                    <strong>æ¡ˆä¾‹5ï¼š</strong> 
                    <span>ORPHA:397ã€OMIM:253800 å’Œ OMIM:153400 ä»£è¡¨å“ªäº›ç–¾ç—…ï¼Ÿ</span>
                </div>
            </div>

            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <div class="content-area">
                <div class="chat-container" id="chatContainer">
                    <div class="message assistant">
                        <div class="message-content">
                            <p>æ¬¢è¿ä½¿ç”¨VCAP-RDAgentç½•è§ç—…æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿï¼</p>
                            <p>æ‚¨å¯ä»¥è¾“å…¥æ‚£è€…çš„ç—‡çŠ¶ã€è¡¨å‹æˆ–HPO IDï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¿›è¡Œè¯Šæ–­åˆ†æã€‚</p>
                            <p>ğŸ’¡ æç¤ºï¼šç‚¹å‡»å·¦ä¾§è¾¹æ ä¸­çš„ç¤ºä¾‹æ¡ˆä¾‹å¯ä»¥å¿«é€Ÿä½¿ç”¨ã€‚</p>
                        </div>
                    </div>
                </div>

                <div class="input-container">
                    <div id="statusIndicator" style="display: none;">
                        <div class="status-indicator" id="statusText1"></div>
                        <div class="status-indicator" id="statusText2" style="display: none;"></div>
                    </div>
                    <div class="input-wrapper">
                        <div class="input-box">
                            <textarea 
                                id="userInput" 
                                placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–ç—‡çŠ¶æè¿°..."
                                rows="1"
                            ></textarea>
                        </div>
                        <div class="button-group">
                            <button class="btn-clear" id="clearBtn" onclick="clearChat()">æ¸…ç©º</button>
                            <button class="btn-send" id="sendBtn" onclick="sendMessage()">
                                <span id="sendBtnText">å‘é€</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–Markdownæ¸²æŸ“å™¨
        function initMarkdown() {
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    breaks: true,  // æ”¯æŒGitHubé£æ ¼çš„æ¢è¡Œ
                    gfm: true,     // å¯ç”¨GitHubé£æ ¼çš„Markdown
                    headerIds: false,  // ç¦ç”¨æ ‡é¢˜IDï¼ˆé¿å…å†²çªï¼‰
                    mangle: false,     // ä¸æ··æ·†é‚®ç®±åœ°å€
                    sanitize: false    // å…è®¸HTMLï¼ˆå› ä¸ºæˆ‘ä»¬ä¿¡ä»»åç«¯è¾“å‡ºï¼‰
                });
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMarkdown);
        } else {
            initMarkdown();
        }

        let sessionId = null;
        let isProcessing = false;
        let statusHistory = []; // å­˜å‚¨çŠ¶æ€å†å²ï¼Œæœ€å¤šä¿ç•™2æ¡

        // åˆå§‹åŒ–ä¼šè¯ID
        function initSession() {
            if (!sessionId) {
                sessionId = 'session_' + Date.now();
            }
        }

        // ä½¿ç”¨ç¤ºä¾‹æ¡ˆä¾‹
        function useExample(exampleText) {
            const input = document.getElementById('userInput');
            input.value = exampleText;
            input.focus();
            // å¯é€‰ï¼šè‡ªåŠ¨å‘é€
            // sendMessage();
        }

        // ç¤ºä¾‹ç‚¹å‡»ï¼šäº‹ä»¶å§”æ‰˜ï¼ˆé¿å…å†…è”onclickè½¬ä¹‰å¯¼è‡´çš„ç‚¹å‡»å¤±æ•ˆï¼Œå°¤å…¶æ˜¯æ¡ˆä¾‹3è¿™ç§JSONæ•°ç»„å­—ç¬¦ä¸²ï¼‰
        document.addEventListener('click', function(e) {
            const el = e.target && e.target.closest ? e.target.closest('.example-case') : null;
            if (!el) return;
            const example = el.getAttribute('data-example');
            if (!example) return;
            useExample(example);
        });

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const query = input.value.trim();

            if (!query || isProcessing) {
                return;
            }

            // ç¦ç”¨è¾“å…¥å’ŒæŒ‰é’®
            isProcessing = true;
            input.disabled = true;
            const sendBtn = document.getElementById('sendBtn');
            const sendBtnText = document.getElementById('sendBtnText');
            sendBtn.disabled = true;
            sendBtnText.innerHTML = '<span class="loading"></span>å¤„ç†ä¸­...';

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            addMessage('user', query);
            input.value = '';

            // æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨
            showStatus('å¤„ç†ä¸­...');

            // åˆå§‹åŒ–ä¼šè¯
            initSession();

            // åˆ›å»ºæ–°çš„åŠ©æ‰‹æ¶ˆæ¯å®¹å™¨
            const assistantMessageId = 'msg_' + Date.now();
            addMessage('assistant', '', assistantMessageId);

            // ä½¿ç”¨fetchå‘é€POSTè¯·æ±‚å¹¶å¤„ç†æµå¼å“åº”
            sendMessageWithFetch(query, assistantMessageId);
        }

        // ä½¿ç”¨fetchå‘é€POSTè¯·æ±‚å¹¶å¤„ç†æµå¼å“åº”
        async function sendMessageWithFetch(query, messageId) {
            try {
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        session_id: sessionId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                const messageContainer = document.getElementById(messageId);

                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) {
                        break;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                
                                if (data.type === 'status') {
                                    showStatus(data.data);
                                } else if (data.type === 'content') {
                                    appendToMessage(messageContainer, data.data);
                                } else if (data.type === 'reasoning') {
                                    appendReasoning(messageContainer, data.data);
                                } else if (data.type === 'error') {
                                    showError(data.data);
                                    resetUI();
                                    return;
                                } else if (data.type === 'done') {
                                    hideStatus();
                                    resetUI();
                                    return;
                                }
                            } catch (e) {
                                console.error('è§£ææ•°æ®é”™è¯¯:', e);
                            }
                        }
                    }
                }

                resetUI();
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯é”™è¯¯:', error);
                showError('å‘é€å¤±è´¥: ' + error.message);
                resetUI();
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©å®¹å™¨
        function addMessage(role, content, messageId = null) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (messageId) {
                contentDiv.id = messageId;
            }
            
            if (content) {
                // ä¿å­˜åŸå§‹å†…å®¹åˆ°dataå±æ€§
                contentDiv.dataset.rawContent = content;
                contentDiv.innerHTML = formatMessage(content);
            } else {
                // åˆå§‹åŒ–ç©ºå†…å®¹
                contentDiv.dataset.rawContent = '';
            }
            
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return contentDiv;
        }

        // è¿½åŠ å†…å®¹åˆ°æ¶ˆæ¯
        function appendToMessage(messageContainer, content) {
            if (messageContainer) {
                // è·å–çˆ¶å…ƒç´ ï¼ˆmessageDivï¼‰ï¼Œæ¨ç†å®¹å™¨åœ¨çˆ¶å…ƒç´ ä¸­
                const messageDiv = messageContainer.parentElement;
                
                // åœ¨é‡æ–°æ¸²æŸ“ä¹‹å‰ï¼Œå…ˆä¿å­˜æ¨ç†å®¹å™¨ï¼ˆä»çˆ¶å…ƒç´ ä¸­æŸ¥æ‰¾ï¼‰
                let savedReasoningContainer = null;
                if (messageDiv) {
                    const existingContainer = messageDiv.querySelector('.reasoning-container');
                    if (existingContainer) {
                        // ä¿å­˜å±•å¼€çŠ¶æ€å’Œå†…å®¹
                        const isExpanded = existingContainer.querySelector('.reasoning-toggle')?.classList.contains('expanded');
                        const reasoningContent = existingContainer.querySelector('.reasoning-content')?.innerHTML || '';
                        savedReasoningContainer = {
                            container: existingContainer.cloneNode(true),
                            expanded: isExpanded,
                            content: reasoningContent
                        };
                    }
                }
                
                // è·å–åŸå§‹æ–‡æœ¬å†…å®¹ï¼ˆå¦‚æœå­˜åœ¨dataå±æ€§ï¼‰ï¼Œå¦åˆ™ä»innerHTMLè§£ç 
                let rawContent = messageContainer.dataset.rawContent || '';
                
                // è¿½åŠ æ–°å†…å®¹åˆ°åŸå§‹æ–‡æœ¬
                rawContent += content;
                
                // ä¿å­˜åŸå§‹æ–‡æœ¬
                messageContainer.dataset.rawContent = rawContent;
                
                // æ ¼å¼åŒ–å¹¶æ˜¾ç¤º
                messageContainer.innerHTML = formatMessage(rawContent);
                
                // é‡æ–°æ·»åŠ æ¨ç†å®¹å™¨åˆ°çˆ¶å…ƒç´ ï¼Œåœ¨contentDivä¹‹å‰ï¼ˆæ¨ç†çª—å£åœ¨æœ€ç»ˆå›å¤ä¹‹å‰ï¼‰
                if (messageDiv && savedReasoningContainer) {
                    // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§å®¹å™¨ï¼ˆé˜²æ­¢é‡å¤ï¼‰
                    const oldContainer = messageDiv.querySelector('.reasoning-container');
                    if (oldContainer) {
                        oldContainer.remove();
                    }
                    // æ·»åŠ ä¿å­˜çš„æ¨ç†å®¹å™¨ï¼Œåœ¨contentDivä¹‹å‰
                    messageDiv.insertBefore(savedReasoningContainer.container, messageContainer);
                    
                    // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼ˆcloneNodeä¸ä¼šå¤åˆ¶äº‹ä»¶ç›‘å¬å™¨ï¼‰
                    const toggle = savedReasoningContainer.container.querySelector('.reasoning-toggle');
                    const content = savedReasoningContainer.container.querySelector('.reasoning-content');
                    if (toggle && content) {
                        // ç›´æ¥æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼ˆcloneNodeåˆ›å»ºçš„èŠ‚ç‚¹æ²¡æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼‰
                        toggle.addEventListener('click', function() {
                            toggle.classList.toggle('expanded');
                            content.classList.toggle('expanded');
                        });
                        
                        // æ¢å¤å±•å¼€çŠ¶æ€
                        if (savedReasoningContainer.expanded) {
                            toggle.classList.add('expanded');
                            content.classList.add('expanded');
                        }
                    }
                }
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // è¿½åŠ æ¨ç†å†…å®¹åˆ°æ¶ˆæ¯
        function appendReasoning(messageContainer, reasoningText) {
            if (!messageContainer) return;
            
            // è·å–çˆ¶å…ƒç´ ï¼ˆmessageDivï¼‰ï¼Œæ¨ç†å®¹å™¨åº”è¯¥å’ŒcontentDivå¹³çº§ï¼Œä½†åœ¨contentDivä¹‹å‰
            const messageDiv = messageContainer.parentElement;
            if (!messageDiv) return;
            
            // æŸ¥æ‰¾æˆ–åˆ›å»ºæ¨ç†å®¹å™¨ï¼ˆåœ¨messageDivä¸­æŸ¥æ‰¾ï¼‰
            let reasoningContainer = messageDiv.querySelector('.reasoning-container');
            if (!reasoningContainer) {
                reasoningContainer = document.createElement('div');
                reasoningContainer.className = 'reasoning-container';
                
                const toggle = document.createElement('div');
                toggle.className = 'reasoning-toggle';
                toggle.innerHTML = `
                    <span>ğŸ’­ æ¨ç†è¿‡ç¨‹</span>
                    <span class="toggle-icon">â–¶</span>
                `;
                
                const content = document.createElement('div');
                content.className = 'reasoning-content';
                
                toggle.addEventListener('click', function() {
                    toggle.classList.toggle('expanded');
                    content.classList.toggle('expanded');
                });
                
                reasoningContainer.appendChild(toggle);
                reasoningContainer.appendChild(content);
                
                // å°†æ¨ç†å®¹å™¨æ·»åŠ åˆ°messageDivä¸­ï¼Œåœ¨contentDivä¹‹å‰ï¼ˆæ¨ç†çª—å£åœ¨æœ€ç»ˆå›å¤ä¹‹å‰ï¼‰
                messageDiv.insertBefore(reasoningContainer, messageContainer);
            }
            
            // è·å–æ¨ç†å†…å®¹åŒºåŸŸ
            const reasoningContent = reasoningContainer.querySelector('.reasoning-content');
            
            // è¿½åŠ æ¨ç†æ–‡æœ¬ï¼ˆè½¬ä¹‰HTMLï¼‰
            const escapedText = escapeHtml(reasoningText);
            reasoningContent.innerHTML += escapedText;
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }


        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆä½¿ç”¨Markdownæ¸²æŸ“ï¼‰
        function formatMessage(text) {
            if (!text) return '';
            
            // å¦‚æœmarked.jså¯ç”¨ï¼Œä½¿ç”¨Markdownæ¸²æŸ“
            if (typeof marked !== 'undefined') {
                try {
                    // ä½¿ç”¨markedæ¸²æŸ“Markdown
                    let html = marked.parse(text);
                    
                    // é«˜äº®ä»£ç å—ï¼ˆå¦‚æœhighlight.jså¯ç”¨ï¼‰
                    if (typeof hljs !== 'undefined') {
                        // ä½¿ç”¨requestAnimationFrameç¡®ä¿DOMæ›´æ–°åå†é«˜äº®
                        requestAnimationFrame(() => {
                            const container = document.getElementById('chatContainer');
                            if (container) {
                                container.querySelectorAll('pre code').forEach((block) => {
                                    if (!block.classList.contains('hljs')) {
                                        hljs.highlightElement(block);
                                    }
                                });
                            }
                        });
                    }
                    
                    return html;
                } catch (e) {
                    console.error('Markdownæ¸²æŸ“é”™è¯¯:', e);
                    // å¦‚æœæ¸²æŸ“å¤±è´¥ï¼Œå›é€€åˆ°ç®€å•è½¬ä¹‰
                    return escapeHtml(text);
                }
            } else {
                // å¦‚æœmarked.jsæœªåŠ è½½ï¼Œä½¿ç”¨ç®€å•è½¬ä¹‰
                return escapeHtml(text);
            }
        }

        // HTMLè½¬ä¹‰å‡½æ•°ï¼ˆå¤‡ç”¨ï¼‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // æ˜¾ç¤ºçŠ¶æ€ï¼ˆæ”¯æŒæ˜¾ç¤ºæœ€è¿‘ä¸¤æ¡çŠ¶æ€ï¼‰
        function showStatus(text) {
            // æ·»åŠ åˆ°çŠ¶æ€å†å²
            statusHistory.push(text);
            
            // åªä¿ç•™æœ€è¿‘2æ¡
            if (statusHistory.length > 2) {
                statusHistory.shift();
            }
            
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText1 = document.getElementById('statusText1');
            const statusText2 = document.getElementById('statusText2');
            
            statusIndicator.style.display = 'block';
            
            // æ˜¾ç¤ºç¬¬ä¸€æ¡çŠ¶æ€ï¼ˆæ—§çš„ï¼Œåœ¨ä¸Šé¢ï¼‰
            if (statusHistory.length >= 2) {
                statusText1.textContent = statusHistory[statusHistory.length - 2];
                statusText1.style.display = 'block';
                statusText1.className = 'status-indicator' + (statusText1.textContent.startsWith('[å·²å®Œæˆ]') ? ' completed' : '');
            } else {
                statusText1.style.display = 'none';
            }
            
            // æ˜¾ç¤ºç¬¬äºŒæ¡çŠ¶æ€ï¼ˆæ–°çš„ï¼Œåœ¨ä¸‹é¢ï¼‰
            if (statusHistory.length >= 1) {
                statusText2.textContent = statusHistory[statusHistory.length - 1];
                statusText2.style.display = 'block';
                statusText2.className = 'status-indicator' + (statusText2.textContent.startsWith('[å·²å®Œæˆ]') ? ' completed' : '');
            } else {
                statusText2.style.display = 'none';
            }
        }

        // éšè—çŠ¶æ€
        function hideStatus() {
            const statusIndicator = document.getElementById('statusIndicator');
            statusIndicator.style.display = 'none';
            statusHistory = []; // æ¸…ç©ºçŠ¶æ€å†å²
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const chatContainer = document.getElementById('chatContainer');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = 'âŒ ' + message;
            chatContainer.appendChild(errorDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // é‡ç½®UI
        function resetUI() {
            isProcessing = false;
            const input = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            const sendBtnText = document.getElementById('sendBtnText');
            
            input.disabled = false;
            sendBtn.disabled = false;
            sendBtnText.textContent = 'å‘é€';
            input.focus();
        }

        // æ¸…ç©ºèŠå¤©
        function clearChat() {
            if (isProcessing) {
                resetUI();
            }
            
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = `
                <div class="message assistant">
                    <div class="message-content">
                        <p>ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ç½•è§ç—…æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿï¼</p>
                        <p>æ‚¨å¯ä»¥è¾“å…¥æ‚£è€…çš„ç—‡çŠ¶ã€è¡¨å‹æˆ–HPO IDï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¿›è¡Œè¯Šæ–­åˆ†æã€‚</p>
                        <p>ğŸ’¡ æç¤ºï¼šç‚¹å‡»å·¦ä¾§è¾¹æ ä¸­çš„ç¤ºä¾‹æ¡ˆä¾‹å¯ä»¥å¿«é€Ÿä½¿ç”¨ã€‚</p>
                    </div>
                </div>
            `;
            
            sessionId = null;
            statusHistory = []; // æ¸…ç©ºçŠ¶æ€å†å²
            hideStatus();
        }

        // å›è½¦å‘é€ï¼ˆShift+Enteræ¢è¡Œï¼‰
        document.getElementById('userInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
        document.getElementById('userInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });
    </script>
</body>
</html>
